var app = angular.module('app', ['angular-loading-bar', 'ui.router', 'ui.bootstrap', 'ui.sortable']);

//testing

app.config(["$stateProvider", "$urlRouterProvider", function($stateProvider, $urlRouterProvider){
	$urlRouterProvider.otherwise('/adItem');

	$stateProvider
		.state('adItem', {
			url: '/adItem',
			templateUrl : 'app/components/adItem/adItem.html',
			controller: 'adItemController',
			controllerAs: 'adItemCtrl'
		});
}]);


var AdItemController = function(adItemService){
	// this.links = "this should be a bunch of links";
	this.adItemService = adItemService;
    this.test = true;
    this.newLinks;
};

AdItemController.prototype.display = function(url){
	var _this = this;
	_this.adItemService.Crawl().sendData(url)
		.then(function(response){
			_this.show = true;
			_this.links = response.links;
			_this.address = response.propertyInfo.address;
			_this.bedRoom = response.propertyInfo.no_bed;
			_this.bathRoom = response.propertyInfo.no_bath;
			_this.carport = response.propertyInfo.no_car;
		});

    var logEntry;
	_this.sortableOptions = {
		//update: function(e, ui){
			//var logEntry = _this.links.map(function(i){
				//return i;
			//}).join(',\n');
			//console.log("Update: " + logEntry);
		//},
		stop: function(e, ui){
			logEntry = _this.links.map(function(i){
				return i;
			});
            _this.adItemService.Crawl().sendLinks(logEntry);
			//console.log("Stop: \n" + logEntry);
		},
        items: ".adItemRow:not(.not-sortable)"
	}

    _this.submit = function(){
        var gotData = _this.adItemService.Crawl().getData();
        var data = {
            links: this.links,
            propertyInfo: gotData.propertyInfo,
            templateDirWeb: gotData.templateDirWeb,
            myWallet: gotData.myWallet
        }

        data.propertyInfo.no_bed = _this.bedRoom;
        data.propertyInfo.no_bath = _this.bathRoom;
        data.propertyInfo.no_car = _this.carport;
        console.log(data);
        _this.adItemService.Crawl().sendFinal(data);
        //console.log(_this.adItemService.Crawl().getLinks());
    }
    
    function set(links){
        this.newLinks = links;
    }
}

//AdItemController.prototype.submit = function(){
    //var _this = this;
	//_this.adItemService.Crawl().sendData(url)
    //_this.adItemService.Crawl().getData().propertyInfo.no_bed = this.bedRoom;
    //console.log(adItemService.Crawl().getData());
//}

angular.module('app')
	.controller('adItemController', ['adItemService', AdItemController]);

var AdItemDirective = function(adItemService){
	var myDirective = {
		restrict: 'AE',
		templateUrl: 'app/components/adItem/adItemDirective.html',
        compile: function(){
            return {
                pre: postLink,
                post: preLink
            }
        },
		//binds "out" with parent scope
		//binds "model" with current scope
		//binds "remove" as a method
		scope:{
			out: "@",
			model: "=",
			remove: "&",
            logo: "@",
            stuff: "="
		}
	};

	return myDirective;

    function postLink(scope, elem, attrs){
        var canvas = elem.find('canvas')[0];
        var context = canvas.getContext('2d');
        scope.$watch('logo', function(lies, truth, scope){
            toggles(lies, truth);
        }, false);

        function toggles(lies, truth){
            console.log(scope.out);
            if(scope.out == 0){
                var service = adItemService.Crawl().getData();
                var image = new Image();
                image.onload = function(){
                    context.drawImage(image, 300, service.myWallet.main.Logo.pos_y);
                }

                context.save();

                if(lies == "true"){
                    image.src = service.templateDirWeb.Logo;
                    context.translate(-100, 0);
                    context.restore();
                }else if(truth == "true"){
                    context.translate(100, 0);
                }
            }
        }
    }

	function preLink(scope, elem, attrs){
        console.log(attrs);
		//define controls
		elem.find('canvas').bind('mouseenter', function(){
			/*elem.find('canvas')jcss('opacity', '0.5');*/
		});

		elem.find('canvas').bind('mouseleave', function(){
			elem.find('canvas').css('opacity', '1');
		});

		var canvas = elem.find('canvas')[0];
		var context = canvas.getContext('2d');
		//context.globalCompositeOperation = "source-over";

		var service = adItemService.Crawl().getData();
		console.log(service);

		var files = [
			service.links[scope.out],
			//service.templateDirWeb.Logo
		];

		if(scope.out ==  0){
			files.push(service.templateDirWeb.Banner);
			files.push(service.templateDirWeb.Bottom);
			files.push(service.templateDirWeb.Bed);
			files.push(service.templateDirWeb.Bath);
			files.push(service.templateDirWeb.Car);
		}

		var images = [];
		var counter = 0;

		for(var i = 0; i < files.length; i++){
			var imageObj = new Image();
			imageObj.src = files[i];
			images.push(imageObj);
			imageObj.onload = function(){
				if(scope.out > 0){
					drawCanvas(images[0], 0, 0, images[0].naturalWidth, images[0].naturalHeight);
					//drawOther();
				}else{
					drawCanvas(images[0], 0, 0, images[0].naturalWidth, images[0].naturalHeight - 30);
					drawMain();
				}
			};
		}

		function drawCanvas(image, x, y, w, h){
			context.drawImage(image, x, y, w, h);
		}

		function drawMain(){
			//drawCanvas(images[1], service.myWallet.main.Logo.pos_x, service.myWallet.main.Logo.pos_y, images[1].naturalWidth, images[1].naturalHeight);
			drawCanvas(images[1], 0, 0, images[1].naturalWidth, images[1].naturalHeight);
			drawCanvas(images[2], 0, 267, images[2].naturalWidth, images[2].naturalHeight + 2);
			drawCanvas(images[3], service.myWallet.main.Bed.pos_x, service.myWallet.main.Bed.pos_y, images[3].naturalWidth, images[3].naturalHeight);
			drawCanvas(images[4], service.myWallet.main.Bath.pos_x, service.myWallet.main.Bath.pos_y, images[4].naturalWidth, images[4].naturalHeight);
			drawCanvas(images[5], service.myWallet.main.Car.pos_x, service.myWallet.main.Car.pos_y, images[5].naturalWidth, images[5].naturalHeight);
			context.save();

			var fontSize = service.myWallet.main.Text.font_size + "pt ";
			var fonts = service.propertyInfo.agency_localDir;
			context.font = fontSize + fonts;
			context.textBaseline = 'alphabetic';
			var text = service.myWallet.main.Text;
			context.fillStyle = "rgb(" + text.colour_r + "," + text.colour_g + "," + text.colour_b + ")";
			context.fillText(service.propertyInfo.no_bed, service.myWallet.main.Bed.t_pos_x, service.myWallet.main.Bed.t_pos_y);
			context.fillText(service.propertyInfo.no_bath, service.myWallet.main.Bath.t_pos_x, service.myWallet.main.Bath.t_pos_y);
			context.fillText(service.propertyInfo.no_car, service.myWallet.main.Car.t_pos_x, service.myWallet.main.Car.t_pos_y);
			//context.translate(200, 150);
			var x = service.myWallet.main.Banner.A.top.t_pos_x;
			var y = service.myWallet.main.Banner.A.top.t_pos_y;
			var t = Math.sqrt(x*x+y*y);
			var a = Math.acos(y/t);
			var b = 0.76 - a;
			var resultX = -t*Math.cos(b);
			var resultY = t*Math.sin(b);

			context.translate(x, y);
			context.rotate(-0.76);
			context.translate(-x, -y);
			context.fillStyle = "rgb(" + text.colour_banner_r + "," + text.colour_banner_g + "," + text.colour_banner_b + ")";
			fontSize = service.myWallet.main.Banner.A.top.font_size + "pt ";
			context.font = fontSize + fonts;
			context.fillText("Auction this", x, y);
			context.restore();
			context.save();
			context.fillStyle = "rgb(" + text.colour_banner_r + "," + text.colour_banner_g + "," + text.colour_banner_b + ")";

			var hour = service.propertyInfo.auction_hour.length;
			var text_x = service.myWallet.main.Banner.A.bottom.Saturday[hour].t_pos_x;
			var text_y = service.myWallet.main.Banner.A.bottom.Saturday[hour].t_pos_y;

			context.translate(text_x, text_y);
			context.rotate(-0.76);
			context.translate(-text_x, -text_y);
			fontSize = service.myWallet.main.Banner.A.bottom.Saturday[hour].font_size + "pt ";
			context.font = fontSize + fonts;
			context.fillText(service.propertyInfo.auction_day + " " + service.propertyInfo.auction_hour, text_x, text_y);
			context.restore();
		}

		function drawOther(){
					drawCanvas(images[1], service.myWallet.other.Logo.pos_x, service.myWallet.other.Logo.pos_y + 31, images[1].naturalWidth, images[1].naturalHeight);
		}
	};
};

angular.module('app')
	.directive('adItem', ['adItemService', AdItemDirective]);

var AdItemService = function($http, $q){
	this.$http = $http;
	this.$q = $q;
};

AdItemService.prototype.Crawl = function(){
	var _this = this;

	var get = {
		sendData: function(url){
			var request = {
				url: url
			}

			var deferred = _this.$q.defer();

			var promise = _this.$http.post('api/crawl', request);

				promise.success(function(response){
					_this.links = response.links;
					_this.propertyInfo = response.propertyInfo;
					_this.templateDirWeb = response.templateDirWeb;
					_this.myWallet = response.myWallet;

					deferred.resolve({
						links: response.links,
						propertyInfo: response.propertyInfo,
						templateDirWeb: response.templateDirWeb,
                        myWallet: response.myWallet
					});
				});
			return deferred.promise;
		},
		getData: function(){
			var data = {
				links: _this.links,
				propertyInfo: _this.propertyInfo,
				templateDirWeb: _this.templateDirWeb,
                myWallet: _this.myWallet
			}
			return data;
		},
        sendLinks: function(input){
             _this.newlinks = input;
            return _this.newLinks;
        },
        getLinks: function(){
            var newlinks = _this.newlinks;
            return newlinks;
        },
        sendFinal: function(data){
            var promise = _this.$http.post('api/sendFinal', data);
        }
	};

	return get;
}

angular.module('app')
	.service('adItemService', ['$http', '$q', AdItemService]);
