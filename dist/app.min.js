var app = angular.module('app', ['angular-loading-bar', 'ui.router', 'ui.bootstrap', 'ui.sortable']);

//testing

app.config(["$stateProvider", "$urlRouterProvider", function($stateProvider, $urlRouterProvider){
    $urlRouterProvider.otherwise('/adItem');

    $stateProvider
        .state('adItem', {
            url: '/adItem',
            templateUrl : 'app/components/adItem/adItem.html',
            controller: 'adItemController',
            controllerAs: 'adItemCtrl'
        });
}]);


var app = angular.module('app');

var AdItemController = function(adItemService){
    // this.links = "this should be a bunch of links";
    this.adItemService = adItemService;
};

AdItemController.prototype.display = function(url){
    var _this = this;
	_this.adItemService.Crawl().sendData(url)
		.then(function(response){
			_this.show = true;
			_this.links = response.links;
			_this.address = response.propertyInfo.address;
			_this.bedRoom = response.propertyInfo.no_bed;
			_this.bathRoom = response.propertyInfo.no_bath;
			_this.carport = response.propertyInfo.no_car;
		});


    /*_this.adItemService.Crawl(url)
        .then(function(response){
			var links = response.data.links;
			var propertyInfo = response.data.propertyInfo;
			var templateDir = response.data.templateDir;

            _this.links = response.data.links;

            //displays input fields
            _this.show = true;
			_this.address = rtyInfo.address;
            _this.bedRoom = propertyInfo.no_bed;
            _this.bathRoom = propertyInfo.no_bath;
            _this.carport = propertyInfo.no_car;
        });*/

    /*_this.adItemService.Templates()
        .then(function(response){
            _this.banner = response.data;
        });*/
}

app.controller('adItemController', ['adItemService', AdItemController]);

var AdItemDirective = function(adItemService){
    var myDirective = {
        restrict: 'AE',
        templateUrl: 'app/components/adItem/adItemDirective.html',
        link: Controls,
        scope:{
			//imgsrc: "@"
            out: "@"
        }
    };

	return myDirective;

	function Controls(scope, elem, attrs){
		console.log(adItemService.Crawl().getData());
		//define controls
		elem.find('canvas').bind('mouseenter', function(){
			/*elem.find('canvas').css('opacity', '0.5');*/
		});

		elem.find('canvas').bind('mouseleave', function(){
			elem.find('canvas').css('opacity', '1');
		});

		elem.find('canvas').bind('mouseenter', function(){
			//console.log(canvas.toDataURL("image/png"));
			console.log('mouseentered the canvas dawg!');
		});

		elem.find('button').bind('click', function(){
			elem.find('canvas').remove(); 
			elem.remove();
		});

		var canvas = elem.find('canvas')[0];
		var context = canvas.getContext('2d');

		var imageObj = new Image();
		var imageBanner = new Image();
		// imageObj.setAttribute('crossOrigin', '*');

		imageObj.onload = function(){
			context.drawImage(imageObj, 0, 0);
		}

		imageBanner.onload = function(){
			context.drawImage(imageBanner, 0, 0)
		}

		imageObj.src = adItemService.Crawl().getData().links[scope.out];
		//imageObj.src = scope.imgsrc;
		//imageObj.src = adItemService.Templates;
	};
};

angular.module('app')
	.directive('adItem', ['adItemService', AdItemDirective]);

var AdItemService = function($http, $q){
	this.$http = $http;
	this.$q = $q;
};

AdItemService.prototype.Crawl = function(){
	var _this = this;

	var get = {
		sendData: function(url){
			var request = {
				url: url
			}

			var deferred = _this.$q.defer();

			var promise = _this.$http.post('api/crawl', request);

				promise.success(function(response){
					_this.links = response.links;
					_this.propertyInfo = response.propertyInfo;
					_this.templateDir = response.templateDir;

					deferred.resolve({
						links: response.links,
						propertyInfo: response.propertyInfo,
						templateDir: response.templateDir
					});
				});
			return deferred.promise;
		},
		getData: function(){
			var data = {
				links: _this.links,
				propertyInfo: _this.propertyInfo,
				templateDir: _this.templateDir
			}
			return data;
		}
	};

	return get;
}

angular.module('app')
	.service('adItemService', ['$http', '$q', AdItemService]);

var app = angular.module('app');

var Trusted = function($sce){
	return function(url){
		return $sce.trustAsResourceUrl(url);
	};
};

app.filter('trusted', ['$sce', Trusted]);